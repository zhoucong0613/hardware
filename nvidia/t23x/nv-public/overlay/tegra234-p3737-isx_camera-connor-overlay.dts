// SPDX-License-Identifier: GPL-2.0-only
// SPDX-FileCopyrightText: Copyright (c) 2018-2023, NVIDIA CORPORATION & AFFILIATES. All rights reserved.

/dts-v1/;
/plugin/;

#include <dt-bindings/clock/tegra234-clock.h>
#include <dt-bindings/gpio/tegra234-gpio.h>
#include <dt-bindings/tegra234-p3737-0000+p3701-0000.h>
#include <dt-bindings/tegra234-p3767-0000-common.h>

#define CAM0_RST    TEGRA234_MAIN_GPIO(H, 3)
#define CAM0_PWDN    TEGRA234_MAIN_GPIO(H, 6)
#define CAM1_PWDN    TEGRA234_MAIN_GPIO(AC, 0)
#define CAM_I2C_MUX     TEGRA234_AON_GPIO(CC, 3)

/* camera control gpio definitions */
/ {
	overlay-name = "Jetson isx Camera Connor";
    jetson-header-name = "Jetson 24pin CSI Connector";
    compatible = JETSON_COMPATIBLE_P3768;

	fragment@0 {
		target-path = "/";

		__overlay__ {
			connor {
				branch {
					label = "fish_camera_isx_v1.0_20251211";
				};
			};
			tegra-capture-vi {
				num-channels = <4>;
				ports {
					status = "okay";
					port@0 {
						status = "okay";
						reg = <0>;
						isx_vi_in0: endpoint {
							status = "okay";
							vc-id = <0>;
							port-index = <2>;
							bus-width = <4>;
							remote-endpoint = <&isx_csi_out0>;
						};
					};
					port@1 {
						status = "okay";
						reg = <1>;
						isx_vi_in1: endpoint {
							status = "okay";
							vc-id = <1>;
							port-index = <2>;
							bus-width = <4>;
							remote-endpoint = <&isx_csi_out1>;
						};
					};
					port@2 {
						status = "okay";
						reg = <2>;
						isx_vi_in2: endpoint {
							status = "okay";
							vc-id = <0>;
							port-index = <1>;
							bus-width = <2>;
							remote-endpoint = <&isx_csi_out2>;
						};
					};
					port@3 {
						status = "okay";
						reg = <3>;
						isx_vi_in3: endpoint {
							status = "okay";
							vc-id = <1>;
							port-index = <1>;
							bus-width = <2>;
							remote-endpoint = <&isx_csi_out3>;
						};
					};
				};
			};
            
			tegra-camera-platform {
				compatible = "nvidia, tegra-camera-platform";
				num_csi_lanes = <4>;
				max_lane_speed = <1500000>;
				min_bits_per_pixel = <10>;
				vi_peak_byte_per_pixel = <2>;
				vi_bw_margin_pct = <25>;
				max_pixel_rate = <7500000>;
				isp_peak_byte_per_pixel = <5>;
				isp_bw_margin_pct = <25>;
			};

			bus@0{
				host1x@13e00000 {
					nvcsi@15a00000 {
						num-channels = <4>;
						channel@0 {
							status = "okay";
							reg = <0>;
							ports {
								status = "okay";
								#address-cells = <1>;
								#size-cells = <0>;
								port@0 {
									status = "okay";
									reg = <0>;
									isx_csi_in0: endpoint {
										status = "okay";
										port-index = <2>;
										bus-width = <4>;
										remote-endpoint = <&isx_cam_out0>;
									};
								};
								port@1 {
									status = "okay";
									reg = <1>;
									isx_csi_out0: endpoint {
										status = "okay";
										remote-endpoint = <&isx_vi_in0>;
									};
								};
							};
						};
						channel@1 {
							status = "okay";
							reg = <1>;
							ports {
								status = "okay";
								#address-cells = <1>;
								#size-cells = <0>;
								port@0 {
									status = "okay";
									reg = <0>;
									isx_csi_in1: endpoint {
										status = "okay";
										port-index = <2>;
										bus-width = <4>;
										remote-endpoint = <&isx_cam_out1>;
									};
								};
								port@1 {
									status = "okay";
									reg = <1>;
									isx_csi_out1: endpoint {
										status = "okay";
										remote-endpoint = <&isx_vi_in1>;
									};
								};
							};
						};
						channel@2 {
							status = "okay";
							reg = <2>;
							ports {
								status = "okay";
								#address-cells = <1>;
								#size-cells = <0>;
								port@0 {
									status = "okay";
									reg = <0>;
									isx_csi_in2: endpoint {
										status = "okay";
										port-index = <1>;
										bus-width = <2>;
										remote-endpoint = <&isx_cam_out2>;
									};
								};
								port@1 {
									status = "okay";
									reg = <1>;
									isx_csi_out2: endpoint {
										status = "okay";
										remote-endpoint = <&isx_vi_in2>;
									};
								};
							};
						};
						channel@3 {
							status = "okay";
							reg = <3>;
							ports {
								status = "okay";
								#address-cells = <1>;
								#size-cells = <0>;
								port@0 {
									status = "okay";
									reg = <0>;
									isx_csi_in3: endpoint {
										status = "okay";
										port-index = <1>;
										bus-width = <2>;
										remote-endpoint = <&isx_cam_out3>;
									};
								};
								port@1 {
									status = "okay";
									reg = <1>;
									isx_csi_out3: endpoint {
										status = "okay";
										remote-endpoint = <&isx_vi_in3>;
									};
								};
							};
						};
					};
				};

                cam_i2cmux {
                    status = "okay";
                    compatible = "i2c-mux-gpio";
                    #address-cells = <1>;
                    #size-cells = <0>;
                    mux-gpios = <&gpio_aon CAM_I2C_MUX GPIO_ACTIVE_HIGH>;
                    i2c-parent = <&cam_i2c>;
					i2c@0 {
						reg = <0>;
						#address-cells = <1>;
						#size-cells = <0>;
						status = "okay";
						dser_0: max96724 {
							status = "okay";
							compatible = "Connor,isx_max96724";
							reg = <0x27>;
							is-master;
						};
						isx_a {
							status = "okay";
							def-addr = <0x1a>; /* actual i2c address of sensor */
							nvidia,gmsl-dser-device = <&dser_0>;
							des-link = "A";

							compatible = "Connor,isx_max9295";

							reg = <0x14>; /* 9295 will translate to this i2c address */

							physical_w = "15.0";
							physical_h = "12.5";
							sensor_model ="isx";
							post_crop_frame_drop = "0";
							use_decibel_gain = "true";

							/* enable CID_SENSOR_MODE_ID for sensor modes selection */
							use_sensor_mode_id = "true";

							mode0 {
								mclk_khz = "24000";
								num_lanes = "2";
								tegra_sinterface = "serial_a";
								vc_id = "0";
								discontinuous_clk = "no";
								dpcm_enable = "false";
								cil_settletime = "0";
								dynamic_pixel_bit_depth = "16";
								csi_pixel_bit_depth = "16"; 
								mode_type = "yuv";
								pixel_phase = "uyvy";

								active_w = "1920";
								active_h = "1536";
								readout_orientation = "0";
								line_length = "2200";
								inherent_gain = "1";
								pix_clk_hz = "165000000";
								serdes_pix_clk_hz = "800000000";

								gain_factor = "10";
								min_gain_val = "0"; /* dB */
								max_gain_val = "420"; /* dB */
								step_gain_val = "3"; /* 0.3 */
								default_gain = "150";
								min_hdr_ratio = "1";
								max_hdr_ratio = "1";
								framerate_factor = "1000000";
								min_framerate = "30000000";
								max_framerate = "30000000";
								step_framerate = "1";
								default_framerate = "30000000";
								exposure_factor = "1000000";
								min_exp_time = "59"; /*us, 2 lines*/
								max_exp_time = "33333";
								step_exp_time = "1";
								default_exp_time = "33333";/* us */
								embedded_metadata_height = "0";
							};

							ports {
								#address-cells = <1>;
								#size-cells = <0>;
								port@0 {
									reg = <0>;
									isx_cam_out0: endpoint {
										vc-id = <0>;
										port-index = <2>;
										bus-width = <4>;
										remote-endpoint = <&isx_csi_in0>;
									};
								};
							};
							gmsl-link {
								num-ser-lanes = <4>;
								streams = "yuv16";
							};
						};
						isx_b {
							status = "okay";
							def-addr = <0x1a>; /* actual i2c address of sensor */
							nvidia,gmsl-dser-device = <&dser_0>;
							des-link = "B";

							compatible = "Connor,isx_max9295";

							reg = <0x15>; /* 9295 will translate to this i2c address */

							physical_w = "15.0";
							physical_h = "12.5";
							sensor_model ="isx";
							post_crop_frame_drop = "0";
							use_decibel_gain = "true";

							/* enable CID_SENSOR_MODE_ID for sensor modes selection */
							use_sensor_mode_id = "true";
							
							mode0 {
								mclk_khz = "24000";
								num_lanes = "2";
								tegra_sinterface = "serial_a";
								vc_id = "2";
								discontinuous_clk = "no";
								dpcm_enable = "false";
								cil_settletime = "0";
								dynamic_pixel_bit_depth = "16";
								csi_pixel_bit_depth = "16"; 
								mode_type = "yuv";
								pixel_phase = "uyvy";

								active_w = "1920";
								active_h = "1536";
								readout_orientation = "0";
								line_length = "2200";
								inherent_gain = "1";
								pix_clk_hz = "165000000";
								serdes_pix_clk_hz = "800000000";

								gain_factor = "10";
								min_gain_val = "0"; /* dB */
								max_gain_val = "420"; /* dB */
								step_gain_val = "3"; /* 0.3 */
								default_gain = "150";
								min_hdr_ratio = "1";
								max_hdr_ratio = "1";
								framerate_factor = "1000000";
								min_framerate = "30000000";
								max_framerate = "30000000";
								step_framerate = "1";
								default_framerate = "30000000";
								exposure_factor = "1000000";
								min_exp_time = "59"; /*us, 2 lines*/
								max_exp_time = "33333";
								step_exp_time = "1";
								default_exp_time = "33333";/* us */
								embedded_metadata_height = "0";
							};

							ports {
								#address-cells = <1>;
								#size-cells = <0>;
								port@0 {
									reg = <0>;
									isx_cam_out1: endpoint {
										vc-id = <1>;
										port-index = <2>;
										bus-width = <4>;
										remote-endpoint = <&isx_csi_in1>;
									};
								};
							};
							gmsl-link {
								num-ser-lanes = <4>;
								streams = "yuv16";
							};
						};
						isx_c {
							status = "okay";
							def-addr = <0x1a>; /* actual i2c address of sensor */
							nvidia,gmsl-dser-device = <&dser_0>;
							des-link = "C";

							compatible = "Connor,isx_max9295";

							reg = <0x16>; /* 9295 will translate to this i2c address */

							physical_w = "15.0";
							physical_h = "12.5";
							sensor_model ="isx";
							post_crop_frame_drop = "0";
							use_decibel_gain = "true";

							/* enable CID_SENSOR_MODE_ID for sensor modes selection */
							use_sensor_mode_id = "true";

							mode0 {
								lane_polarity = "6";
								mclk_khz = "24000";
								num_lanes = "2";
								tegra_sinterface = "serial_a";
								vc_id = "2";
								discontinuous_clk = "no";
								dpcm_enable = "false";
								cil_settletime = "0";
								dynamic_pixel_bit_depth = "16";
								csi_pixel_bit_depth = "16"; 
								mode_type = "yuv";
								pixel_phase = "uyvy";

								active_w = "1920";
								active_h = "1536";
								readout_orientation = "0";
								line_length = "2200";
								inherent_gain = "1";
								pix_clk_hz = "165000000";
								serdes_pix_clk_hz = "800000000";

								gain_factor = "10";
								min_gain_val = "0"; /* dB */
								max_gain_val = "420"; /* dB */
								step_gain_val = "3"; /* 0.3 */
								default_gain = "150";
								min_hdr_ratio = "1";
								max_hdr_ratio = "1";
								framerate_factor = "1000000";
								min_framerate = "30000000";
								max_framerate = "30000000";
								step_framerate = "1";
								default_framerate = "30000000";
								exposure_factor = "1000000";
								min_exp_time = "59"; /*us, 2 lines*/
								max_exp_time = "33333";
								step_exp_time = "1";
								default_exp_time = "33333";/* us */
								embedded_metadata_height = "0";
							};

							ports {
								#address-cells = <1>;
								#size-cells = <0>;
								port@0 {
									reg = <0>;
									isx_cam_out2: endpoint {
										vc-id = <0>;
										port-index = <1>;
										bus-width = <2>;
										remote-endpoint = <&isx_csi_in2>;
									};
								};
							};
							gmsl-link {
								num-ser-lanes = <4>;
								streams = "yuv16";
							};
						};

						isx_d {
							status = "okay";
							def-addr = <0x1a>; /* actual i2c address of sensor */
							nvidia,gmsl-dser-device = <&dser_0>;
							des-link = "D";

							compatible = "Connor,isx_max9295";

							reg = <0x17>; /* 9295 will translate to this i2c address */

							physical_w = "15.0";
							physical_h = "12.5";
							sensor_model ="isx";
							post_crop_frame_drop = "0";
							use_decibel_gain = "true";

							/* enable CID_SENSOR_MODE_ID for sensor modes selection */
							use_sensor_mode_id = "true";

							mode0 {
								lane_polarity = "6";
								mclk_khz = "24000";
								num_lanes = "2";
								tegra_sinterface = "serial_a";
								vc_id = "2";
								discontinuous_clk = "no";
								dpcm_enable = "false";
								cil_settletime = "0";
								dynamic_pixel_bit_depth = "16";
								csi_pixel_bit_depth = "16"; 
								mode_type = "yuv";
								pixel_phase = "uyvy";

								active_w = "1920";
								active_h = "1536";
								readout_orientation = "0";
								line_length = "2200";
								inherent_gain = "1";
								pix_clk_hz = "165000000";
								serdes_pix_clk_hz = "800000000";

								gain_factor = "10";
								min_gain_val = "0"; /* dB */
								max_gain_val = "420"; /* dB */
								step_gain_val = "3"; /* 0.3 */
								default_gain = "150";
								min_hdr_ratio = "1";
								max_hdr_ratio = "1";
								framerate_factor = "1000000";
								min_framerate = "30000000";
								max_framerate = "30000000";
								step_framerate = "1";
								default_framerate = "30000000";
								exposure_factor = "1000000";
								min_exp_time = "59"; /*us, 2 lines*/
								max_exp_time = "33333";
								step_exp_time = "1";
								default_exp_time = "33333";/* us */
								embedded_metadata_height = "0";
							};

							ports {
								#address-cells = <1>;
								#size-cells = <0>;
								port@0 {
									reg = <0>;
									isx_cam_out3: endpoint {
										vc-id = <1>;
										port-index = <1>;
										bus-width = <2>;
										remote-endpoint = <&isx_csi_in3>;
									};
								};
							};
							gmsl-link {
								num-ser-lanes = <4>;
								streams = "yuv16";
							};
						};
					};
				};
			};
		};
	};
};